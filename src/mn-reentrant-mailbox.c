/* Generated by GOB (v2.0.14)   (do not edit directly) */

/* End world hunger, donate to the World Food Programme, http://www.wfp.org */

#define GOB_VERSION_MAJOR 2
#define GOB_VERSION_MINOR 0
#define GOB_VERSION_PATCHLEVEL 14

#define selfp (self->_priv)

#include <string.h> /* memset() */

#include "mn-reentrant-mailbox.h"

#include "mn-reentrant-mailbox-private.h"

#ifdef G_LIKELY
#define ___GOB_LIKELY(expr) G_LIKELY(expr)
#define ___GOB_UNLIKELY(expr) G_UNLIKELY(expr)
#else /* ! G_LIKELY */
#define ___GOB_LIKELY(expr) (expr)
#define ___GOB_UNLIKELY(expr) (expr)
#endif /* G_LIKELY */

#line 29 "mn-reentrant-mailbox.gob"

#include "config.h"
#include <gtk/gtk.h>
#include "mn-mailbox-private.h"
#include "mn-util.h"

typedef struct
{
  MNReentrantMailbox	*self;
  unsigned long		check_id;
} CheckInfo;

#line 39 "mn-reentrant-mailbox.c"
/* self casting macros */
#define SELF(x) MN_REENTRANT_MAILBOX(x)
#define SELF_CONST(x) MN_REENTRANT_MAILBOX_CONST(x)
#define IS_SELF(x) MN_IS_REENTRANT_MAILBOX(x)
#define TYPE_SELF MN_TYPE_REENTRANT_MAILBOX
#define SELF_CLASS(x) MN_REENTRANT_MAILBOX_CLASS(x)

#define SELF_GET_CLASS(x) MN_REENTRANT_MAILBOX_GET_CLASS(x)

/* self typedefs */
typedef MNReentrantMailbox Self;
typedef MNReentrantMailboxClass SelfClass;

/* here are local prototypes */
static void mn_reentrant_mailbox_init (MNReentrantMailbox * o) G_GNUC_UNUSED;
static void mn_reentrant_mailbox_class_init (MNReentrantMailboxClass * c) G_GNUC_UNUSED;
static void ___1_mn_reentrant_mailbox_removed (MNMailbox * mailbox) G_GNUC_UNUSED;
static void ___2_mn_reentrant_mailbox_finalize (GObject * object) G_GNUC_UNUSED;
static gboolean mn_reentrant_mailbox_queue_check_cb (gpointer data) G_GNUC_UNUSED;
static void ___5_mn_reentrant_mailbox_check (MNMailbox * mailbox) G_GNUC_UNUSED;
static void mn_reentrant_mailbox_check_thread_cb (CheckInfo * info) G_GNUC_UNUSED;
static void mn_reentrant_mailbox_reentrant_check (MNReentrantMailbox * self, unsigned long check_id) G_GNUC_UNUSED;

/* pointer to the class of our parent */
static MNMailboxClass *parent_class = NULL;

/* Short form macros */
#define self_queue_check mn_reentrant_mailbox_queue_check
#define self_queue_check_cb mn_reentrant_mailbox_queue_check_cb
#define self_check_thread_cb mn_reentrant_mailbox_check_thread_cb
#define self_reentrant_check mn_reentrant_mailbox_reentrant_check
#define self_check_aborted mn_reentrant_mailbox_check_aborted
#define self_check_aborted_unlocked mn_reentrant_mailbox_check_aborted_unlocked
#define self_lock mn_reentrant_mailbox_lock
#define self_unlock mn_reentrant_mailbox_unlock
GType
mn_reentrant_mailbox_get_type (void)
{
	static GType type = 0;

	if ___GOB_UNLIKELY(type == 0) {
		static const GTypeInfo info = {
			sizeof (MNReentrantMailboxClass),
			(GBaseInitFunc) NULL,
			(GBaseFinalizeFunc) NULL,
			(GClassInitFunc) mn_reentrant_mailbox_class_init,
			(GClassFinalizeFunc) NULL,
			NULL /* class_data */,
			sizeof (MNReentrantMailbox),
			0 /* n_preallocs */,
			(GInstanceInitFunc) mn_reentrant_mailbox_init,
			NULL
		};

		type = g_type_register_static (MN_TYPE_MAILBOX, "MNReentrantMailbox", &info, (GTypeFlags)G_TYPE_FLAG_ABSTRACT);
	}

	return type;
}

/* a macro for creating a new object of our type */
#define GET_NEW ((MNReentrantMailbox *)g_object_new(mn_reentrant_mailbox_get_type(), NULL))

/* a function for creating a new object of our type */
#include <stdarg.h>
static MNReentrantMailbox * GET_NEW_VARG (const char *first, ...) G_GNUC_UNUSED;
static MNReentrantMailbox *
GET_NEW_VARG (const char *first, ...)
{
	MNReentrantMailbox *ret;
	va_list ap;
	va_start (ap, first);
	ret = (MNReentrantMailbox *)g_object_new_valist (mn_reentrant_mailbox_get_type (), first, ap);
	va_end (ap);
	return ret;
}


static void
___finalize(GObject *obj_self)
{
#define __GOB_FUNCTION__ "MN:Reentrant:Mailbox::finalize"
	MNReentrantMailbox *self G_GNUC_UNUSED = MN_REENTRANT_MAILBOX (obj_self);
	gpointer priv G_GNUC_UNUSED = self->_priv;
#line 63 "mn-reentrant-mailbox.gob"
	___2_mn_reentrant_mailbox_finalize(obj_self);
#line 126 "mn-reentrant-mailbox.c"
#line 44 "mn-reentrant-mailbox.gob"
	if(self->_priv->mutex) { g_mutex_free ((gpointer) self->_priv->mutex); self->_priv->mutex = NULL; }
#line 129 "mn-reentrant-mailbox.c"
}
#undef __GOB_FUNCTION__

static void 
mn_reentrant_mailbox_init (MNReentrantMailbox * o G_GNUC_UNUSED)
{
#define __GOB_FUNCTION__ "MN:Reentrant:Mailbox::init"
	o->_priv = G_TYPE_INSTANCE_GET_PRIVATE(o,MN_TYPE_REENTRANT_MAILBOX,MNReentrantMailboxPrivate);
#line 44 "mn-reentrant-mailbox.gob"
	o->_priv->mutex = g_mutex_new();
#line 140 "mn-reentrant-mailbox.c"
}
#undef __GOB_FUNCTION__
static void 
mn_reentrant_mailbox_class_init (MNReentrantMailboxClass * c G_GNUC_UNUSED)
{
#define __GOB_FUNCTION__ "MN:Reentrant:Mailbox::class_init"
	GObjectClass *g_object_class G_GNUC_UNUSED = (GObjectClass*) c;
	MNMailboxClass *mn_mailbox_class = (MNMailboxClass *)c;

	g_type_class_add_private(c,sizeof(MNReentrantMailboxPrivate));

	parent_class = g_type_class_ref (MN_TYPE_MAILBOX);

#line 51 "mn-reentrant-mailbox.gob"
	mn_mailbox_class->removed = ___1_mn_reentrant_mailbox_removed;
#line 63 "mn-reentrant-mailbox.gob"
	g_object_class->finalize = ___finalize;
#line 103 "mn-reentrant-mailbox.gob"
	mn_mailbox_class->check = ___5_mn_reentrant_mailbox_check;
#line 160 "mn-reentrant-mailbox.c"
	c->reentrant_check = NULL;
}
#undef __GOB_FUNCTION__



#line 51 "mn-reentrant-mailbox.gob"
static void 
___1_mn_reentrant_mailbox_removed (MNMailbox * mailbox G_GNUC_UNUSED)
#line 170 "mn-reentrant-mailbox.c"
#define PARENT_HANDLER(___mailbox) \
	{ if(MN_MAILBOX_CLASS(parent_class)->removed) \
		(* MN_MAILBOX_CLASS(parent_class)->removed)(___mailbox); }
{
#define __GOB_FUNCTION__ "MN:Reentrant:Mailbox::removed"
{
#line 53 "mn-reentrant-mailbox.gob"
	
    Self *self = SELF(mailbox);

    self_lock(self);
    selfp->check_id = 0;
    self_unlock(self);

    PARENT_HANDLER(mailbox);
  }}
#line 187 "mn-reentrant-mailbox.c"
#undef __GOB_FUNCTION__
#undef PARENT_HANDLER

#line 63 "mn-reentrant-mailbox.gob"
static void 
___2_mn_reentrant_mailbox_finalize (GObject * object G_GNUC_UNUSED)
#line 194 "mn-reentrant-mailbox.c"
#define PARENT_HANDLER(___object) \
	{ if(G_OBJECT_CLASS(parent_class)->finalize) \
		(* G_OBJECT_CLASS(parent_class)->finalize)(___object); }
{
#define __GOB_FUNCTION__ "MN:Reentrant:Mailbox::finalize"
{
#line 65 "mn-reentrant-mailbox.gob"
	
    Self *self = SELF(object);

    if (selfp->queue_check_source)
      mn_locked_g_source_remove(selfp->queue_check_source);

    PARENT_HANDLER(object);
  }}
#line 210 "mn-reentrant-mailbox.c"
#undef __GOB_FUNCTION__
#undef PARENT_HANDLER

#line 83 "mn-reentrant-mailbox.gob"
void 
mn_reentrant_mailbox_queue_check (MNReentrantMailbox * self)
#line 217 "mn-reentrant-mailbox.c"
{
#define __GOB_FUNCTION__ "MN:Reentrant:Mailbox::queue_check"
#line 83 "mn-reentrant-mailbox.gob"
	g_return_if_fail (self != NULL);
#line 83 "mn-reentrant-mailbox.gob"
	g_return_if_fail (MN_IS_REENTRANT_MAILBOX (self));
#line 224 "mn-reentrant-mailbox.c"
{
#line 85 "mn-reentrant-mailbox.gob"
	
    if (selfp->queue_check_source)
      mn_locked_g_source_remove(selfp->queue_check_source);

    selfp->queue_check_source = mn_g_idle_add_gdk_locked(self_queue_check_cb, self);
  }}
#line 233 "mn-reentrant-mailbox.c"
#undef __GOB_FUNCTION__

#line 92 "mn-reentrant-mailbox.gob"
static gboolean 
mn_reentrant_mailbox_queue_check_cb (gpointer data)
#line 239 "mn-reentrant-mailbox.c"
{
#define __GOB_FUNCTION__ "MN:Reentrant:Mailbox::queue_check_cb"
{
#line 94 "mn-reentrant-mailbox.gob"
	
    Self *self = data;

    mn_mailbox_check(MN_MAILBOX(self));

    selfp->queue_check_source = NULL;
    return FALSE;		/* remove source */
  }}
#line 252 "mn-reentrant-mailbox.c"
#undef __GOB_FUNCTION__

#line 103 "mn-reentrant-mailbox.gob"
static void 
___5_mn_reentrant_mailbox_check (MNMailbox * mailbox G_GNUC_UNUSED)
#line 258 "mn-reentrant-mailbox.c"
#define PARENT_HANDLER(___mailbox) \
	{ if(MN_MAILBOX_CLASS(parent_class)->check) \
		(* MN_MAILBOX_CLASS(parent_class)->check)(___mailbox); }
{
#define __GOB_FUNCTION__ "MN:Reentrant:Mailbox::check"
{
#line 105 "mn-reentrant-mailbox.gob"
	
    Self *self = SELF(mailbox);
    CheckInfo *info;

    PARENT_HANDLER(mailbox);

    mn_mailbox_set_error(mailbox, NULL);

    if (++selfp->check_unique_id == 0)
      ++selfp->check_unique_id;

    info = g_new(CheckInfo, 1);
    info->self = g_object_ref(self);
    info->check_id = selfp->check_unique_id;

    self_lock(self);
    selfp->check_id = info->check_id;
    self_unlock(self);

    mn_thread_create((GThreadFunc) self_check_thread_cb, info);
  }}
#line 287 "mn-reentrant-mailbox.c"
#undef __GOB_FUNCTION__
#undef PARENT_HANDLER

#line 127 "mn-reentrant-mailbox.gob"
static void 
mn_reentrant_mailbox_check_thread_cb (CheckInfo * info)
#line 294 "mn-reentrant-mailbox.c"
{
#define __GOB_FUNCTION__ "MN:Reentrant:Mailbox::check_thread_cb"
{
#line 129 "mn-reentrant-mailbox.gob"
	
    Self *self = info->self;

    self_reentrant_check(self, info->check_id);

    self_lock(self);
    if (selfp->check_id == info->check_id)
      selfp->check_id = 0;
    self_unlock(self);

    GDK_THREADS_ENTER();

    g_object_unref(self);

    gdk_flush();
    GDK_THREADS_LEAVE();

    g_free(info);
  }}
#line 318 "mn-reentrant-mailbox.c"
#undef __GOB_FUNCTION__

#line 149 "mn-reentrant-mailbox.gob"
static void 
mn_reentrant_mailbox_reentrant_check (MNReentrantMailbox * self, unsigned long check_id)
#line 324 "mn-reentrant-mailbox.c"
{
	MNReentrantMailboxClass *klass;
#line 149 "mn-reentrant-mailbox.gob"
	g_return_if_fail (self != NULL);
#line 149 "mn-reentrant-mailbox.gob"
	g_return_if_fail (MN_IS_REENTRANT_MAILBOX (self));
#line 331 "mn-reentrant-mailbox.c"
	klass = MN_REENTRANT_MAILBOX_GET_CLASS(self);

	if(klass->reentrant_check)
		(*klass->reentrant_check)(self,check_id);
}

#line 152 "mn-reentrant-mailbox.gob"
gboolean 
mn_reentrant_mailbox_check_aborted (MNReentrantMailbox * self, unsigned long check_id)
#line 341 "mn-reentrant-mailbox.c"
{
#define __GOB_FUNCTION__ "MN:Reentrant:Mailbox::check_aborted"
#line 152 "mn-reentrant-mailbox.gob"
	g_return_val_if_fail (self != NULL, (gboolean )0);
#line 152 "mn-reentrant-mailbox.gob"
	g_return_val_if_fail (MN_IS_REENTRANT_MAILBOX (self), (gboolean )0);
#line 348 "mn-reentrant-mailbox.c"
{
#line 154 "mn-reentrant-mailbox.gob"
	
    gboolean aborted;

    self_lock(self);
    aborted = selfp->check_id != check_id;
    self_unlock(self);

    return aborted;
  }}
#line 360 "mn-reentrant-mailbox.c"
#undef __GOB_FUNCTION__

#line 164 "mn-reentrant-mailbox.gob"
gboolean 
mn_reentrant_mailbox_check_aborted_unlocked (MNReentrantMailbox * self, unsigned long check_id)
#line 366 "mn-reentrant-mailbox.c"
{
#define __GOB_FUNCTION__ "MN:Reentrant:Mailbox::check_aborted_unlocked"
#line 164 "mn-reentrant-mailbox.gob"
	g_return_val_if_fail (self != NULL, (gboolean )0);
#line 164 "mn-reentrant-mailbox.gob"
	g_return_val_if_fail (MN_IS_REENTRANT_MAILBOX (self), (gboolean )0);
#line 373 "mn-reentrant-mailbox.c"
{
#line 166 "mn-reentrant-mailbox.gob"
	
    return selfp->check_id != check_id;
  }}
#line 379 "mn-reentrant-mailbox.c"
#undef __GOB_FUNCTION__

#line 170 "mn-reentrant-mailbox.gob"
void 
mn_reentrant_mailbox_lock (MNReentrantMailbox * self)
#line 385 "mn-reentrant-mailbox.c"
{
#define __GOB_FUNCTION__ "MN:Reentrant:Mailbox::lock"
#line 170 "mn-reentrant-mailbox.gob"
	g_return_if_fail (self != NULL);
#line 170 "mn-reentrant-mailbox.gob"
	g_return_if_fail (MN_IS_REENTRANT_MAILBOX (self));
#line 392 "mn-reentrant-mailbox.c"
{
#line 172 "mn-reentrant-mailbox.gob"
	
    g_mutex_lock(selfp->mutex);
  }}
#line 398 "mn-reentrant-mailbox.c"
#undef __GOB_FUNCTION__

#line 176 "mn-reentrant-mailbox.gob"
void 
mn_reentrant_mailbox_unlock (MNReentrantMailbox * self)
#line 404 "mn-reentrant-mailbox.c"
{
#define __GOB_FUNCTION__ "MN:Reentrant:Mailbox::unlock"
#line 176 "mn-reentrant-mailbox.gob"
	g_return_if_fail (self != NULL);
#line 176 "mn-reentrant-mailbox.gob"
	g_return_if_fail (MN_IS_REENTRANT_MAILBOX (self));
#line 411 "mn-reentrant-mailbox.c"
{
#line 178 "mn-reentrant-mailbox.gob"
	
    g_mutex_unlock(selfp->mutex);
  }}
#line 417 "mn-reentrant-mailbox.c"
#undef __GOB_FUNCTION__
